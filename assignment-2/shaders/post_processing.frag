#version 330 core
out vec4 FragColor;

in vec2 TexCoords;

uniform sampler2D screenTexture;
uniform sampler2D noiseTexture;
uniform bool comparisonMode;
uniform float sliderPosition;
uniform float sliderWidth;
uniform float sliderLineWidth;
uniform vec3 sliderColor;
uniform float sliderHandleSize;
uniform vec3 sliderHandleColor;
uniform bool showSliderHandle;
uniform int effectType;
uniform int viewMode;
uniform float edgeThreshold;
uniform float pixelizationScale;
uniform vec2 magnifierCenter;
uniform float magnifierRadius;
uniform float magnifierStrength;
uniform float mouseX;
uniform float mouseY;
uniform float time;
uniform float screenWidth;
uniform float screenHeight;
        
vec4 blurEffect(vec4 color, vec2 uv, vec2 texelsize) {
    float kernel[13] = float[](0.001, 0.008, 0.036, 0.109, 0.210, 0.254, 0.210, 0.109, 0.036, 0.008, 0.001, 0.0, 0.0);
    vec4 colorU = vec4(0.0);

    for (int i = -6; i <= 6; ++i) {
        colorU += texture(screenTexture, uv + vec2(i, 0) * texelsize) * kernel[i + 6];
    }

    vec4 colorV = vec4(0.0);
    for (int i = -6; i <= 6; ++i) {
        colorV += texture(screenTexture, uv + vec2(0, i) * texelsize) * kernel[i + 6];
    }

    return (colorU + colorV) / 2.0;
}

vec4 applySineWaveDistortion(vec4 color, vec2 texCoord) {
    float wave = sin(texCoord.y * 10.0 + time) * 0.05;
    vec2 distortedCoord = texCoord + vec2(wave, 0.0);
    return texture(screenTexture, distortedCoord);
}

vec4 applyPixelizationEffect(vec4 color) {
    vec2 texSize = vec2(textureSize(screenTexture, 0));
    vec2 pixelSize = vec2(1.0) / vec2(pixelizationScale)/texSize;
    vec2 coord = floor(TexCoords / pixelSize) * pixelSize;
    vec4 pixelColor = texture(screenTexture, coord);
    return pixelColor;
}

vec4 applyBloomEffect(vec4 color) {
    vec4 bloompass1 = blurEffect(color, TexCoords, vec2(1.0) / vec2(textureSize(screenTexture, 0)));
    vec4 bloompass2 = blurEffect(bloompass1, TexCoords, vec2(1.0) / vec2(textureSize(screenTexture, 0)));
    vec4 finalBloom = mix(color, bloompass1, 0.2);
    finalBloom = mix(finalBloom,bloompass2, 0.6);
    return finalBloom;
}

vec4 applyMagnifierEffect(vec4 color, vec2 texCoord) {
    vec2 magnifierPos = magnifierCenter;
    vec2 aspectRatio = vec2(screenWidth, screenHeight);
    aspectRatio = normalize(aspectRatio);
    float dist = distance(texCoord * aspectRatio, magnifierPos * aspectRatio);
    if (dist < magnifierRadius) {
        float scale = magnifierStrength;
        vec2 offset = (texCoord - magnifierPos) / scale;
        return texture(screenTexture, magnifierPos + offset);
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    return color;
}

vec4 applyWatercolorEffect(vec4 color) {
    return texture(screenTexture, TexCoords+vec2(0.01, 0.01) * texture(noiseTexture, TexCoords).rg * 0.1);
}

vec4 abstractionEffect(vec4 color) {
    vec2 texelSize = 1.0 / vec2(textureSize(screenTexture, 0));
    vec4 blurredColor = blurEffect(color, TexCoords, texelSize);
    vec4 DoGColor = color - blurredColor;
    float edgeValue = length(DoGColor.rgb);
    vec4 edgeColor = vec4(0.2, 0.2, 0.2, edgeValue);
    vec4 finalColor = vec4(blurredColor.rgb, 1.0-edgeColor.a ) + edgeColor;
    return edgeColor.a > edgeThreshold ?  edgeColor: blurredColor;
}

vec4 applyPostProcessing(vec4 color) {
    switch(effectType) {
        case 0:
            float average = 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
            return vec4(vec3(average), color.a);
        case 1:
            return abstractionEffect(color);
        case 2:
            return applyWatercolorEffect(color);
        case 3:
            return applyMagnifierEffect(color, TexCoords);
        case 4:
            return applyBloomEffect(color);
        case 5:
            return applyPixelizationEffect(color);
        case 6:
            return applySineWaveDistortion(color, TexCoords);
        default:
            return color;
    }
}

void main()
{
    vec2 texCoord = TexCoords;
    vec4 texColor = texture(screenTexture, texCoord);
    vec4 processedColor = applyPostProcessing(texColor);
    vec4 finalColor = texColor;

    if (viewMode == 2) {
        if(effectType == 3) {
            finalColor = applyPostProcessing(texColor);
        }
        else{
            if (texCoord.x > sliderPosition) {
            finalColor = processedColor;
            }
            float distToSlider = abs(texCoord.x - sliderPosition);
            if (distToSlider < sliderLineWidth) {
                finalColor = vec4(sliderColor, 1.0);
            }
            if (showSliderHandle) {
                float vertCenter = 0.5;
                float dist = distance(vec2(texCoord.x, texCoord.y), vec2(sliderPosition, vertCenter));
                if (dist < sliderHandleSize) {
                    finalColor = vec4(sliderHandleColor, 1.0);
                }
            }
        }
    }
    if (viewMode == 2) {
        FragColor = finalColor;
    }
    else {
        FragColor = texColor;
    }
}
